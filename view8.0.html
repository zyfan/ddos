<!DOCTYPE html>
<html>
<head>
  <meta charset = "utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DDoS Attack</title>
    <link rel="stylesheet" type="text/css" href="ddos4.css">
  <script type="text/javascript" src = "d3.js" charset="utf-8"></script>
  <script src="http://www.ourd3js.com/library/multext.js" charset="utf-8"></script>
  <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.0.js">
  </script>
  <link rel="stylesheet" href="jquery.range.css">
  <script src="jquery.range.js"></script>
  <script>
    $(function(){
      $('.range').jRange({
        from: 1,
        to: 31,
        step: 1,
        scale: [1, 6, 11, 16, 21, 26, 31],
        format: '%s',
        width: 650,
        height: 150,
        showLabels: true,
        isRange: true
      });

      $('.range2').jRange({
        from: 0,
        to: 24,
        step: 1,
        scale: [0, 4, 8, 12, 16, 20, 24],
        format: '%s',
        width: 650,
        height: 200,
        showLabels: true,
        isRange: true
      });

      $('.range3').jRange({
        from: 0,
        to: 60,
        step: 1,
        scale: [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60],
        format: '%s',
        width: 650,
        height: 200,
        showLabels: true,
        isRange: true
      });

      $('.range4').jRange({
        from: 0,
        to: 60,
        step: 1,
        scale: [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60],
        format: '%s',
        width: 650,
        height: 200,
        showLabels: true,
        isRange: true
      });

      $(".range").mousemove(function(){
        var gg = $(".range").val();
        alert(gg);
      });


    });

    $(function(){
       window.onload = function()
       {
         var $li = $('#tab li');
         var $ul = $('#content ul');

         $li.mouseover(function(){
             var $this = $(this);
             var $t = $this.index();
             $li.removeClass();
             $this.addClass('current');
             $ul.css('display', 'none');
             $ul.eq($t).css('display', 'block');
         });



       }
     });
  </script>
  
</head>
<body>
 <div id="matrix" style="position:absolute;left:460px;top:33.35px">
  
 </div>
 <div id="view4" style="position:absolute;left:887.11px;top:225px ">

 </div>
 

 <div id="timeAxis" style="position:absolute;left:470px;top:440.22px">
   IP(A.B.C.D)-A <input onchange="timeaxis()" id="timeaxis1" type="range" name="points" min="0" max="255" step="1" value="0" />
   IP(A.B.C.D)-B <input onchange="timeaxis()" id="timeaxis2" type="range" name="points" min="0" max="255" step="1" value="0" />
   <input type="text" id="time1" style="width: 26.68px" />
   .
   <input type="text" id="time2" style="width: 26.68px" />
   
   <input type="button" id="timesubmit" value = "submit" onclick="SwitchData();" />

 </div>
 


 <div id="view2" style="position:absolute;left:887.11px;top:33.35px">
 
 </div>

 <div id="colorRect" style="position:absolute;left:1100.55px;top:33.35px">

 </div> 

 <div id = "tBar" style="position:absolute;left:453.56px;top:10px">
    Attack times <input onchange="changeTimes()" id = "timesBar" type="range" name="points" min = "0" max="100" step="1" value="0" />
    <input type="text" id="times" style="position:absolute;left:250px;top:0px" value="0"></input>
 </div>



 <div id="outer" style="position:absolute;left:460px;top:400.2px">
   <ul id="tab">
     <li class="current"> Timeline </li>
     <li> Details </li>
     
   </ul>
   <div id="content">
     <ul id="timeline" style="display:block;">
       <input type="button" id="timesubmit" value="submit" onclick="timeChange()" style="position:absolute;left:660px;top:255px" />

       Day: <input class="range" type="hidden" value="5, 20" />
       <br />
       <br />
       Hour: <input class="range2" type="hidden" value="7, 18" />
       <br />
       <br />
       Minute: <input class="range3" type="hidden" value="10, 50" />
       <br />
       <br />
       Second: <input class="range4" type="hidden" value="10, 50" />
       <br />
       <br />

     </ul>
     <ul id="details" style="overflow-y:auto; height: 200.1px; width: 650px">
      
        <table width="650" height="193.43" border = "2" cellpadding="10">

        </table>

     </ul>
   </div>
 </div>

 <div id="view3"  >
    <p style="position:absolute;left: 60px;top:0px">srcIP</p>
    <p style="position:absolute;left: 380px;top:0px">destIP</p>
 </div>

 <div id="brush" style="position:absolute;left:20px;top:10px">
  <input type="button" value="clear" onclick="brush();" />
   
 </div>



 <script type="text/javascript">
    var svg = null; //matrix1用
    var svg1 = null; //view4用
    var svg2 = null; //details用
    var svg3 = null; //view2用
    var svg4 = null; //view2颜色渐变矩形用
    var svg5 = null; //view3 graph 用

    
    var Data;
    var Data2 = new Array();
    var Data4 = new Array();
    var csvdata2;
    //var csvdata;
    var Data3 = new Array();
    var destIP = new Array();
    var edgesG = new Array();
    var srcIP = [];
    var value = 10000;
    var currentTimes = 0;
    var ipa = 0;
    var ipb = 0;
    var flag = 1;
    var Position;
    var Position2;
    var Position3;
    var day1;
    var day2;
    var hour1;
    var hour2;
    var minute1;
    var minute2;
    var second1;
    var second2;



    start();
    
    //用户第一次打开网页的时候要显示matrix，不要显示一片空白
    //相当于初始化
    function start(){
       svg = d3.select("#matrix").append("svg")
            .attr("class", "axis")
            .attr("width", 416.875)
            .attr("height", 400.2);

      svg1 = d3.select("#view4").append("svg")
            .attr("class", "axis")
            .attr("width", 300)
            .attr("height", 210);

      svg3 = d3.select("#view2").append("svg")
            .attr("class", "axis")
            .attr("width", 186.76)
            .attr("height", 186.76);

      svg5 = d3.select("#view3").append("svg")
            .attr("class", "axis")
            .attr("width", 416.875)
            .attr("height", 710);

       

        drawXAxis();

        drawYAxis();
    }



    //主要函数
    function search(){
      d3.selectAll("svg").remove();

    var v1;
    var v2;
    var k;
    var mess = 0;
    var j = 0;
    //var flag = 0;//因为计算机多线程，所以等待数据都读入进后再执行主函数
    destIP = [];
    Data = [];
    Data2 = [];
    Data4 = [];
    Data3 = [];
    var nodes = [];
    var edges = [];

     


    d3.csv("datatry.csv", function (error, csvdata){
      // body...
      if(error){
        console.log(error);
      }
      //console.log(csvdata);

      console.log("2ipa="+ipa);
      console.log("2ipb="+ipb);
      //console.log(csvdata);


      //决定ip的前两部分的位数
      if(ipa>99){
         if(ipb>99){
             Position = 4;
             Position2 = 8;//C为从8开始
         }else
         if(ipb>9){
            Position = 4;
            Position2 = 7;
         }else{
            Position = 4;
            Position2 = 6;
         }
      }else
      if(ipa>9){
        if(ipb>99){
             Position = 3;
             Position2 = 7;
         }else
         if(ipb>9){
            Position = 3;
            Position2 = 6;
         }else{
            Position = 3;
            Position2 = 5;
         }

      }else{
        if(ipb>99){
             Position = 2;
             Position2 = 6;
         }else
         if(ipb>9){
            Position = 2;
            Position2 = 5;
         }else{
            Position = 2;
            Position2 = 4;
         }

      }

      var pos1;//代表月份开头的位置
      var pos2;//代表日期开头的位置
      var postime1;//代表分钟开头的位置
      var postime2;//代表秒开头的位置
      var si = 1;
      var sl = 1;
       
      for(var i=0;i<csvdata.length;i++){
      
       for(var tmp9=0;tmp9<10;tmp9++){
          if(csvdata[i].date.substring(tmp9, tmp9+1) == "/" && si == 1){
               pos1 = tmp9+1;
               si = 0;
             
          }else{
          if(csvdata[i].date.substring(tmp9, tmp9+1) == "/" && si == 0){
               pos2 = tmp9+1;
             

            }
           }
          if(csvdata[i].time.substring(tmp9, tmp9+1) == ":" && sl == 1){
            postime1 = tmp9+1;
            sl = 0;
          }else{
            if(csvdata[i].time.substring(tmp9, tmp9+1) == ":" && sl == 0){
              postime2 = tmp9+1;
            }
          }
          }
        //console.log("pos1="+pos1+" pos2="+pos2);


        if(parseInt(csvdata[i].date.substring(pos2, csvdata[i].date.length)) >= day1 && parseInt(csvdata[i].date.substring(pos2, csvdata[i].date.length)) <= day2){ //选择时间段－天
            if(parseInt(csvdata[i].time.substring(0, 2)) >= hour1 && parseInt(csvdata[i].time.substring(0, 2)) <= hour2){//选择时间段－小时
              if(parseInt(csvdata[i].time.substring(3, 5)) >= minute1 && parseInt(csvdata[i].time.substring(3, 5)) <= minute2){//选择时间段－分钟
                if(parseInt(csvdata[i].time.substring(6, 8)) >= second1 && parseInt(csvdata[i].time.substring(6, 8)) <= second2){
                  //选择时间段－秒
                   
                   
                  if(csvdata[i].destIP.substring(0, Position-1) == ipa && csvdata[i].destIP.substring(Position, Position2-1) == ipb){ //选择destIpA与B
                      for(var h=Position2;h<csvdata[i].destIP.length;h++){
                        if(csvdata[i].destIP.substring(h, h+1) == "."){
                           Position3 = h+1;
              
                         }
                      }
                      var len = csvdata[i].destIP.length;
                      if(j == 0){//第一次进
                        destIP[j++] = parseInt(csvdata[i].destIP.substring(Position2, Position3-1));
                        destIP[j++] = parseInt(csvdata[i].destIP.substring(Position3, len));
                        destIP[j++] = 1;//本ip次数为1

                      }else{
                        for(k=0;k<destIP.length;k++){
            
                         if(parseInt(csvdata[i].destIP.substring(Position2, Position3-1)) == destIP[k] && parseInt(csvdata[i].destIP.substring(Position3, len)) == destIP[k+1]){

                               destIP[k+2]++;
           
                               break;
                            }else{
                               k = k+2;
                               //console.log("meiyisi i="+i);
                            }

                         }
                         if(k == destIP.length){//没找到重复的，所以新加入ip
            
                             destIP[j++] = parseInt(csvdata[i].destIP.substring(Position2, Position3-1));
                             destIP[j++] = parseInt(csvdata[i].destIP.substring(Position3, len));
                             destIP[j++] = 1;
                          }

                      }


                  }

                }

              }
            }
        }


      }


   //console.log(destIP);
    drawView2();

   // drawDetails();

    drawGraph();

    drawMatrix();

    //drawView4();


    });
  }
    




/********************** View 1 Part ***********************************/
   //draw the two matrix above
    function drawMatrix(){
       // tst = 2;
        var pos;
        var dataum = new Array();
        for(var i = 0;i<169;i++){
          dataum[i] = 0;


        }

        for(var w=0;w<destIP.length;w++){
           pos = parseInt(destIP[w]/20)+parseInt(destIP[w+1]/20)*13;//算哪个格
           dataum[pos] += destIP[w+2];
           w += 2;
        }

        var width = 625*0.667;
        var height = 600*0.667;
        var cx;
        var cy;

        svg = d3.select("#matrix").append("svg")
            .attr("class", "axis")
            .attr("width", width)
            .attr("height", height)
            .call(
              d3.behavior.zoom()
                   .scaleExtent([1, 10])
                   .on("zoom", zoom)
              )
            .append("g");

       /* var zoom = d3.behavior.zoom()
                    .scaleExtent([1, 10])
                    .on("zoom", zoomed);*/


         svg1 = d3.select("#view4").append("svg")
            .attr("class", "axis")
            .attr("width", 300)
            .attr("height", 210);

         svg4 =  d3.select("#colorRect").append("svg")
               .attr("class", "axis")
               .attr("width", 150)
               .attr("height", 50*0.667)
               .append("g");

         svg5 = d3.select("#view3").append("svg")
            .attr("class", "axis")
            .attr("width", 416.875)
            .attr("height", 710)
            .call(
              d3.behavior.zoom()
                   .scaleExtent([1, 10])
                   .on("zoom", zoom2)
              )
            .append("g");





        //准备小矩形颜色插值
        var maxvalue = d3.max(dataum);
        var minvalue = d3.min(dataum);

        var linear = d3.scale.linear()
                       .domain([minvalue, maxvalue])
                       .range([0, 1]);

        var a = d3.rgb(255, 255, 255);
        var b = d3.rgb(0, 0, 255);
        var c = d3.rgb(255, 0, 255);

        var computeColor = d3.interpolate(a, b);
        //var computeColor2 = d3.interpolate(b, c);



        //增加小矩形为了实现选中效果
          svg.selectAll(".MyRect")
              .data(dataum)
              .enter()
              .append("rect")
              .attr("class", "MyRect")
              .attr("x", function(d, i){
                
                 return (10+(i%13+1)*39.3)*0.667;

              })
              .attr("y", function(d, i){
                 return (550-(parseInt(i/13)+1)*39.3)*0.667;
              })
              .attr("width", 40*0.667)
              .attr("height", 40*0.667)
              .style("fill", function(d, i){
                var t = linear(d);
                var color = computeColor(t);
                return color.toString();
              })
              .on("mouseover", function(){
                d3.select(this)
                  .attr("stroke", "red")
                  .attr("stroke-width", 3);

              })
              .on("mouseout", function(){
                d3.select(this)
                  .attr("stroke", "none");
              })
              .on("click", function(){
                //在view2上显示该小矩阵内所有点

                d3.selectAll(".Circle").remove();//清除view2中所有的circle
                d3.selectAll(".colorrect").remove();
                d3.selectAll(".valueText").remove();
                //d3.selectAll(".MyRect").attr("stroke", "none");

                d3.select(this).attr("stroke", "red");

                svg5.selectAll(".lineG")
                             .attr("stroke", "#eee9e9");

                 var mouse = d3.mouse(this);
                 cx = mouse[0]/0.667;
                 cy = mouse[1]/0.667;
                 //console.log("cx="+cx+"cy="+cy);

                //判读用户点击的位置
                 if(cx<87){
                  v1 = 0;

                 }else
                 if(cx<126.5){
                  v1 = 1;
                 }else
                 if(cx<165){
                  v1 = 2;
                 }else
                 if(cx<204){
                  v1 = 3;
                 }else
                 if(cx<246){
                  v1 = 4;

                 }else
                 if(cx<284){
                  v1 = 5;

                 }else
                 if(cx<326){
                  v1 = 6;

                 }else
                 if(cx<364){
                  v1 = 7;

                 }else
                 if(cx<402){
                  v1 = 8;

                 }else
                 if(cx<443){
                  v1 = 9;

                 }else
                 if(cx<482){
                  v1 = 10;

                 }else
                 if(cx<522){
                  v1 = 11;

                 }else{
                  v1 = 12;

                 }

                 if(cy>512){
                  v2 = 0;

                 }else
                 if(cy>473){
                  v2 = 1;

                 }else
                 if(cy>434){
                  v2 = 2;

                 }else
                 if(cy>395){
                  v2 = 3;

                 }else
                 if(cy>356){
                  v2 = 4;

                 }else
                 if(cy>317){
                  v2 = 5;

                 }else
                 if(cy>278){
                  v2 = 6;

                 }else
                 if(cy>237){
                  v2 = 7;

                 }else
                 if(cy>197){
                  v2 = 8;

                 }else
                 if(cy>158){
                  v2 = 9;

                 }else
                 if(cy>119){
                  v2 = 10;

                 }else
                 if(cy>82){
                  v2 = 11;

                 }else{
                  v2 = 12;

                 }

                 chooseCircle(v1, v2);

                 drawZAxis(v1, v2);//画view2的数据线

                

              });

        drawXAxis();

        drawYAxis();

        //drawXAxis2();

        //drawYAxis2();

        console.log(destIP);

        drawRect();

        drawPoints();

       // drawGraph();

       

       //专门为缩放的函数
        function zoom(){
            svg.attr("transform", "translate(" + d3.event.translate +
              ")scale(" +d3.event.scale + ")");
        }

        function zoom2(){
            svg5.attr("transform", "translate(" + d3.event.translate +
              ")scale(" +d3.event.scale + ")");
        }

        //专门为选择某一小矩形而筛选数据的
        function chooseCircle(v1, v2){
           //Data2 = ***********************;

           var tmp1 = (v1+1)*20;//右上角x
           var tmp2 = (v2+1)*20;//右上角y
           var tmp3 = v1*20;//左下角x
           var tmp4 = v2*20;//左下角y

           var posi1;
           var posi2;
           var posi3;
           var length1;
           var fg = 1;


           Data3 = destIP.concat();

           //console.log("hahaha00");

           if(ipa>99){
              posi1 = 4;
              if(ipb>99){
            posi2 = 8;
           }else if(ipb>9){
            posi2 = 7;
           }else{
            posi2 = 6;
           }
           }else if(ipa>9){
              posi1 = 3;
              if(ipb>99){
            posi2 = 7;
           }else if(ipb>9){
            posi2 = 6;
           }else{
            posi2 = 5;
           }
           }else{
            posi1 = 2;
            if(ipb>99){
            posi2 = 6;
           }else if(ipb>9){
            posi2 = 5;
           }else{
            posi2 = 4;
           }
           }
           
           //console.log("hahaha000");

           for(var p=0;p<edgesG.length;p++){
            //console.log("hahaha111");
              console.log(edgesG[p].target.substring(0, posi1-1));
              console.log("ipa="+ipa);
            if(parseInt(edgesG[p].target.substring(0, posi1-1)) == ipa){
              if(parseInt(edgesG[p].target.substring(posi1, posi2-1)) == ipb){
                length1 = edgesG[p].target.length;
                for(var pp=posi2;pp<15;pp++){
                   if(edgesG[p].target.substring(pp, pp+1) == "." ){
                        posi3 = pp+1;
                        break;
                      }
                    }
                    console.log("hahaha");
                if(parseInt(edgesG[p].target.substring(posi2, posi3-1))<= tmp1 && parseInt(edgesG[p].target.substring(posi2, posi3-1)) >= tmp3){
                  console.log("hahaha1");
                    if(parseInt(edgesG[p].target.substring(posi3, length1)) >= tmp4 && parseInt(edgesG[p].target.substring(posi3, length1)) <= tmp2){
                      console.log("hahaha2");
                            //选定了一小矩阵中～
                          //console.log(edgesG[p].target);


                         d3.selectAll("#view3 svg g g line")
                          .attr("id", function(d, i){

                            if(edgesG[i].target == edgesG[p].target){
                              d3.select(this)
                              .style("fill", "blue")
                              .attr("stroke", "blue")
                              .attr("stroke-width", 3);
                              //console.log("hahaha244");
                            }
                           
                          });
                            
                    }
                }
                 
              }
            }
           }
         
           //!!svg5.selectAll("#")
           
        }

        function drawZAxis(v1, v2){
          var p = 1;
          var n = 0;
          var p1 = 1;
          var n1 = 0;
          var j2 = 0;
          var j3 = 0;
          
          //var tmp2 = 550-(v2+1)*39.3;//左上角y
          //var tmp3 = 10+(v1+1)*39.3;//左下角x
          var tmp2 = (v2+1)*20;
          var tmp3 = v1*20;

          var percent1;//x轴比例
          var percent2;//y轴比例
          var maxTimes = 0;
          var maxNum = 0;
          var strIP;

          var DataTimes = new Array();
          var DataForce = new Array();//力导向图用

          /*for(var j=0;j<Data3.length/3;j++){
            if(Data3[2+j*3] > currentTimes){
            DataTimes[j] = Data3[2+j*3];
            }else{
              DataTimes[j] = 0;
            }
            
          }*/

          for(var j=0;j<Data3.length/3;j++){
           // DataTimes[j] = Data3[2+j*3];
            if(Data3[j*3]>=tmp3 && Data3[j*3]<=(tmp3+20)){
              if(Data3[1+j*3]>=(tmp2-20) && Data3[1+j*3]<=tmp2){
                //提取出view2中显示的点
                 DataForce[j2++] = Data3[j*3];
                 DataForce[j2++] = Data3[j*3+1];
                 DataForce[j2++] = Data3[j*3+2];
                 DataTimes[j3++] = Data3[2+j*3];
                 if(DataTimes[j3-1] > maxTimes){
                  //通过这个一步步找到DataForce所存ip的times的最大值
                   maxTimes = DataTimes[j3-1];
                   maxNum = j2 -3;
                 }
              }
            }
            
          }


          //console.log(DataTimes);
          //console.log("v1="+v1+"v2="+v2);
          //颜色插值
          var maxvalue = d3.max(DataTimes);
          var minvalue = d3.min(DataTimes);

          var linear = d3.scale.linear()
                       .domain([minvalue, maxvalue])
                       .range([0, 1]);

          var a = d3.rgb(0, 255, 255);
          var b = d3.rgb(0, 0, 255);

          var computeColor = d3.interpolate(a, b);


          var defs = svg4.append("defs");

          var linearGradient = defs.append("linearGradient")
                                 .attr("id", "linearColor")
                                 .attr("x1", "0%")
                                 .attr("y1", "0%")
                                 .attr("x2", "100%")
                                 .attr("y2", "0%");

          var stop1 = linearGradient.append("stop")
                                 .attr("offset", "0%")
                                 .style("stop-color", a.toString());

          var stop2 = linearGradient.append("stop")
                                 .attr("offset", "100%")
                                 .style("stop-color", b.toString());

          var colorRect = svg4.append("rect")
                        .attr("class", "colorrect")
                        .attr("x", 20*0.667)
                        .attr("y", 20*0.667)
                        .attr("width", 100*0.667)
                        .attr("height", 20*0.667)
                        .style("fill", "url(#" + linearGradient.attr("id") + ")");
          var minValueText = svg4.append("text")
                        .attr("class", "valueText")
                        .attr("x", 10*0.667)
                        .attr("y", 20*0.667)
                        
                        .text(function(){
                          console.log("minvalue="+minvalue);
                          return minvalue;
                        });

          var maxValueText = svg4.append("text")
                        .attr("class", "valueText")
                        .attr("x", 120*0.667)
                        .attr("y", 20*0.667)
                        
                        .text(function(){
                          console.log("maxvalue="+maxvalue);
                          return maxvalue;
                        });
          

           svg3.selectAll(".Circle")
               .data(DataTimes)
               .enter()
               .append("g")
               .append("circle")
               .attr("class", "Circle")
               .style("fill", function(d, i){
                var t = linear(d);
                var color = computeColor(t);
                return color.toString();
               })
               .attr("stroke", "black")
               .attr("cx", function(d, i){
                  percent1 = (DataForce[n]-tmp3)/20; //x轴比例
                  
                  n = n+3;
                  //console.log(Data3);

                 //console.log("aaa="+percent1*280*0.667);

                  return percent1*150+18.38; 
               })
               .attr("cy", function(d, i){
                 percent2 = (tmp2-DataForce[p])/20; //y轴比例

                 p = p+3;

                 //console.log("bbb="+percent2*280*0.667);

                  return percent2*150+18.38;
               })
               .attr("r", 7)
               .on("mouseover", function(d, i){
                d3.select(this).transition()
                  .attr("stroke", "red");
                
                var tmp16 = 0;
                var ddd = d;

                var ccc = d3.mouse(this);
                var cxx = ccc[0];
                var cyy = ccc[1];

                var tips = svg3.append("g").attr("class", ".tips");
                tips.append("rect")
                    .attr("class", "tips-border")
                    .attr("width", 200)
                    .attr("height", 50)
                    .attr("x", function(){
                       if(cxx > 95) cxx -= 90;
                       return cxx;
                    })
                    .attr("y", function(){
                      if(cyy > 135) cyy -= 50;
                      return cyy;

                    })
                    .attr("rx", 10*0.667)
                    .attr("ry", 10*0.667);

                var word1 = tips.append("text")
                    .attr("class", "tips-text")
                    .attr("x", cxx+7)
                    .attr("y", cyy+25)
                    .text(function(){
                      return "Times: "+ddd;
                    });

             
              })
              .on("mouseout", function(){
                d3.select(this).transition()
                  .attr("stroke", "black");

               svg3.selectAll(".tips-text").remove();
               svg3.selectAll(".tips-border").remove();

                d3.select(".tips")
                  .style("display", "none");
                  
              })
              .on("click", function(d, i){
                strIP = ipa + "";
                strIP = strIP +"." + (ipb+"");
                strIP = strIP +"."+ (DataForce[i*3]+"");
                strIP = strIP +"."+ (DataForce[i*3+1]+"");

                drawView4(strIP);
                
              });

          strIP = ipa + "";
          strIP = strIP +"." + (ipb+"");
          strIP = strIP +"."+ (DataForce[maxNum]+"");
          strIP = strIP +"."+ (DataForce[maxNum+1]+"");

          console.log("strIP="+strIP);

          drawView4(strIP);


          
        
        }


    }

    function drawXAxis(){
        var length = 500*0.667;

        var scale = d3.scale.linear()
                     .domain([0, 255])
                     .range([0, length]);

        var xAxis = d3.svg.axis()
                     .scale(scale)
                     .orient("bottom")
                     .ticks(18);

        svg.append("g")
           .attr("class", "xaxis")
           .attr("transform", "translate(33.35, 366.85)")
           .call(xAxis);

        d3.selectAll("g.xaxis g.tick")
          .append("line")
          .classed("gird-line", true)
          .attr("class", "axisline")
          .attr("x1", 0)
          .attr("y1", 0)
          .attr("x2", 0)
          .attr("y2", -333.5);

    }

    function drawYAxis(){
        var length = 500*0.667;

        var scale = d3.scale.linear()
                     .domain([255, 0])
                     .range([0, length]);

        var yAxis = d3.svg.axis()
                     .scale(scale)
                     .orient("left")
                     .ticks(18);

        svg.append("g")
           .attr("class", "yaxis")
           .attr("transform", "translate(33.35, 33.35)")
           .call(yAxis);

        d3.selectAll("g.yaxis g.tick")
          .append("line")
          .classed("gird-line", true)
          .attr("class", "axisline")
          .attr("x1", 0)
          .attr("y1", 0)
          .attr("x2", 333.5)
          .attr("y2", 0);
    }

    function drawXAxis2(){
        var length = 500;

        var scale = d3.scale.linear()
                     .domain([0, 255])
                     .range([0, length]);

        var xAxis = d3.svg.axis()
                     .scale(scale)
                     .orient("bottom")
                     .ticks(18);

        svg1.append("g")
           .attr("class", "xaxis")
           .attr("transform", "translate(50, 550)")
           .call(xAxis);

        d3.selectAll("g.xaxis g.tick")
          .append("line")
          .classed("gird-line", true)
          .attr("x1", 0)
          .attr("y1", 0)
          .attr("x2", 0)
          .attr("y2", -500);

    }

    function drawYAxis2(){
        var length = 500;

        var scale = d3.scale.linear()
                     .domain([255, 0])
                     .range([0, length]);

        var yAxis = d3.svg.axis()
                     .scale(scale)
                     .orient("left")
                     .ticks(18);

        svg1.append("g")
           .attr("class", "yaxis")
           .attr("transform", "translate(50, 50)")
           .call(yAxis);

        d3.selectAll("g.yaxis g.tick")
          .append("line")
          .classed("gird-line", true)
          .attr("x1", 0)
          .attr("y1", 0)
          .attr("x2", 500)
          .attr("y2", 0);
    }

    function drawRect(){

      var dataset3 = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];//matrix的y轴
      var dataset4 = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];//matrix的x轴

      for(var i=0;i<destIP.length;i++){
       if(i%3 != 2){
        if(destIP[i] < 20){
          if(i%3 == 0){
            dataset4[0] += destIP[i+2];
          }else{
            dataset3[12]+= destIP[i+1];
          }
        }else
        if(destIP[i] < 40){
          if(i%3 == 0){
            dataset4[1]+= destIP[i+2];
          }else{
            dataset3[11]+= destIP[i+1];
          }
        }else
        if(destIP[i] < 60){
          if(i%3 == 0){
            dataset4[2]+= destIP[i+2];
          }else{
            dataset3[10]+= destIP[i+1];
          }
        }else
        if(destIP[i] < 80){
          if(i%3 == 0){
            dataset4[3]+= destIP[i+2];
          }else{
            dataset3[9]+= destIP[i+1];
          }
        }else
        if(destIP[i] < 100){
          if(i%3 == 0){
            dataset4[4]+= destIP[i+2];
          }else{
            dataset3[8]+= destIP[i+1];
          }
        }else
        if(destIP[i] < 120){
          if(i%3 == 0){
            dataset4[5]+= destIP[i+2];
          }else{
            dataset3[7]+= destIP[i+1];
          }
        }else
        if(destIP[i] < 140){
          if(i%3 == 0){
            dataset4[6]+= destIP[i+2];
          }else{
            dataset3[6]+= destIP[i+1];
          }
        }else
        if(destIP[i] < 160){
          if(i%3 == 0){
            dataset4[7]+= destIP[i+2];
          }else{
            dataset3[5]+= destIP[i+1];
          }
        }else
        if(destIP[i] < 180){
          if(i%3 == 0){
            dataset4[8]+= destIP[i+2];
          }else{
            dataset3[4]+= destIP[i+1];
          }
        }else
        if(destIP[i] < 200){
          if(i%3 == 0){
            dataset4[9]+= destIP[i+2];
          }else{
            dataset3[3]+= destIP[i+1];
          }
        }else
        if(destIP[i] < 220){
          if(i%3 == 0){
            dataset4[10]+= destIP[i+2];
          }else{
            dataset3[2]+= destIP[i+1];
          }
        }else
        if(destIP[i] < 240){
          if(i%3 == 0){
            dataset4[11]+= destIP[i+2];
          }else{
            dataset3[1]+= destIP[i+1];
          }
        }else 
        if(destIP[i]<255){

          if(i%3 == 0){
            dataset4[12]+= destIP[i+2];
          }else{
            dataset3[0]+= destIP[i+1];
          }
        }


       }
      }

      console.log(dataset3);
      console.log(dataset4);

      var total = 0;
      var total2 = 0;

      for(var i=0;i<dataset3.length;i++){
          total += dataset3[i]*dataset3[i];
          total2 += dataset4[i]*dataset4[i];
      }

      i = 0;
      
      //为了数据均一化
      total = Math.sqrt(total);
      total2 = Math.sqrt(total2);

     //四根横纵坐标的线
      var line1 = svg.append("line")
                   .attr("x1", 0)
                   .attr("y1", 50*0.667)
                   .attr("x2", 0)
                   .attr("y2", 600*0.667)
                   .attr("stroke", "red")
                   .attr("stroke-width", 2);

      var line2 = svg.append("line")
                   .attr("x1", 0)
                   .attr("y1", 600*0.667)
                   .attr("x2", 600*0.667)
                   .attr("y2", 600*0.667)
                   .attr("stroke", "red")
                   .attr("stroke-width", 2);


      //lines represent the quantity of the attack in one line
      //线之间的间隔
      var linePadding = 39*0.667;

      var start = 60*0.667;
      var start2 = 47;

      var lines1 = svg.selectAll(".MyLine")
                    .data(dataset3)
                    .enter()
                    .append("line")
                    .attr("class", "MyLine")
                    .attr("stroke", "red")
                    .attr("stroke-width", 10)
                   // .attr("transform", "translate(39, 39)" )
                    .attr("x1", 0)
                    .attr("y1", function(d, i){
                     
                      return start+i*linePadding;
                    })
                    .attr("y2", function(d, i){
                     // console.log("aaaaa");
                      return start+i*linePadding;
                    })
                    .attr("x2", function(d, i){
                      //console.log(d);
                      //console.log("bbbbb");
                      if(total != 0)
                        return d/total *50*0.667;
                      else return 0;
                    })
                    .on("click", function(){
                       alert("这个小柱状图表示：该矩阵每排受到的攻击次数多少的比较，均已均一化显示");
                    });

      var lines2 = svg.selectAll(".MyLine2")
                     .data(dataset4)
                     .enter()
                     .append("line")
                     .attr("stroke", "red")
                     .attr("stroke-width", 10)
                     .attr("class", "MyLine2")
                     .attr("x1", function(d, i){
                        return start2+i*linePadding; 
                     })
                     .attr("y1", 600*0.667)
                     .attr("x2", function(d, i){
                        return start2+i*linePadding; 
                     })
                     .attr("y2", function(d, i){
                       if(total2 != 0)
                        return (600-d/total2 *50)*0.667;
                       else return 600*0.667;
                     })
                     .on("click", function(){
                       alert("这个小柱状图表示：该矩阵每列受到的攻击次数多少的比较，均已均一化显示");
                    });

    }


    function drawPoints() {

       Data2 = [];
       Data4 = [];
       var j = 0;
      // console.log(destIP);

      svg.selectAll("circle").remove();
      //svg.selectAll("circle").remove();

      
       for(var u=0;u<destIP.length;u++){
         //console.log(destIP);
         if(destIP[u+2] > currentTimes){
          Data2[j] = destIP[u];//destIp中的c项
          Data4[j] = destIP[u+1];//destIp中的d项
          j++;

          
         }
          u = u+2;
          
       }

                  
                 //console.log(Data2);
                 //console.log(Data4);
            var circle = svg.selectAll("circle")
                            .data(Data2)
                            .enter()
                            .append("g")
                            .append("circle")
                            //.append("id",function(d,i){return "dot"+i;})
                            .attr("class", "circles")
                            .attr("cx", function(d, i){
                              //console.log("2333");
                                return (1.965*d+49)*0.667;//乘2是因为按比例放大，20的空间用39.3px表示，所以1要用2px来表示
                            })
                            .attr("cy", function(d, i){
                                return (1.965*Data4[i]*(-1)+550)*0.667;
                            })
                            .attr("r", 1.35)
                            .on("mouseover", function(){
                                 //console.log("2331");
                               d3.select(this).transition().attr("r", 1.7)
                                 .attr("stroke", "red");
                               //d3.select(".sign").style("display", "block");

                            })
                           .on("mouseout", function(){
                            //console.log("2332");
                               d3.select(this).transition().attr("r", 1.35)
                                 .attr("stroke", "white");
                            })
                           .on("click", function(d,i){
                              //点击matrix的圆圈后在svg2中显示details
                              //清除所有text

                              //svg2.selectAll("text").remove();
                              //output();
                              

                              var str = " dateTime: ";
                              var mm = d3.mouse(this);
                              var cc = Math.round(mm[0]);
                              var dd = Math.round(mm[1]);
                              
                              d3.csv("data2.csv", function(error, csvdata){
                                //console.log(csvdata);
                             
                              var IPC = d;
                              var IPD = Data4[i];
                              console.log("IPC="+IPC+"IPD="+IPD);

                              var pos1;//代表月份开头的位置
                              var pos2;//代表日期开头的位置
                              var postime1;//代表分钟开头的位置
                              var postime2;//代表秒开头的位置
                              var si = 1;
                              var sl = 1;

                              
         for(var t=0;t<csvdata.length;t++){
                                  //这么写没问题，但是时间复杂度过大，可以改，比如按时间顺序排序数据集，知道某一时间点数据有多少，就可以不用.length了

             for(var tmp9=0;tmp9<10;tmp9++){
          if(csvdata[t].date.substring(tmp9, tmp9+1) == "/" && si == 1){
               pos1 = tmp9+1;
               si = 0;
             
          }else{
          if(csvdata[t].date.substring(tmp9, tmp9+1) == "/" && si == 0){
               pos2 = tmp9+1;
             

            }
           }

          if(csvdata[t].time.substring(tmp9, tmp9+1) == ":" && sl == 1){
            postime1 = tmp9+1;
            sl = 0;
          }else{
            if(csvdata[t].time.substring(tmp9, tmp9+1) == ":" && sl == 0){
              postime2 = tmp9+1;
            }
          }
          }

          var len1 = csvdata[t].time.length;


          if(parseInt(csvdata[t].date.substring(pos2, csvdata[t].date.length)) >= day1 && parseInt(csvdata[t].date.substring(pos2, csvdata[t].date.length)) <= day2){ //选择时间段－天
            if(parseInt(csvdata[t].time.substring(0, 2)) >= hour1 && parseInt(csvdata[t].time.substring(0, 2)) <= hour2){//选择时间段－小时
              if(parseInt(csvdata[t].time.substring(3, 5)) >= minute1 && parseInt(csvdata[t].time.substring(3, 5)) <= minute2){//选择时间段－分钟
                if(parseInt(csvdata[t].time.substring(6, 8)) >= second1 && parseInt(csvdata[t].time.substring(6, 8)) <= second2){
                  //选择时间段－秒
                   
                   
                  if(csvdata[t].destIP.substring(0, Position-1) == ipa && csvdata[t].destIP.substring(Position, Position2-1) == ipb){ //选择destIpA与B
                      for(var h=Position2;h<csvdata[t].destIP.length;h++){
                        if(csvdata[t].destIP.substring(h, h+1) == "."){
                           Position3 = h+1;
              
                         }
                      }
                      var len = csvdata[t].destIP.length;
                                 
                      if(parseInt(csvdata[t].destIP.substring(Position2, Position3-1)) == IPC && parseInt(csvdata[t].destIP.substring(Position3, len)) == IPD){

                            $(document).ready(function(){
                                $("#content ul table").append("<tr><td align='left' valign='top'><span>date: </span>" +csvdata[t].date+" <span>time: </span>"+csvdata[t].time+" <span>SrcIp: </span>"+csvdata[t].srcIP+" <span>destIp: </span>"+csvdata[t].destIP+" <span>port: </span>"+csvdata[t].port+" <span>flow: </span>"+csvdata[t].flow+"</td></tr>");
                                $("#content ul table tr td span").css("font-weight", "bold");

                            });
                                        
                        }
                       }
                     }
                   }
                  }
                }
              }
                                
                              //appendMultiText(svg2, str, 20, 20, 1000, 15,"simsun");

                            });

                        });


    }




/*********************** View2 Part ************************************/
    function drawView2() {
      var width = 280*0.667;
      var height = 280*0.667;
      svg3 = d3.select("#view2").append("svg")
            .attr("class", "axis")
            .attr("width", width)
            .attr("height", height)
            .call(
              d3.behavior.zoom()
                   .scaleExtent([1, 10])
                   .on("zoom", zoom)
              )
            .append("g");

     // draw3DAxis();

      //drawZAxis();

      function zoom(){
            svg3.attr("transform", "translate(" + d3.event.translate +
              ")scale(" +d3.event.scale + ")");
        }

      
    }

    function draw3DAxis(){
       var defs = svg3.append("defs");

       var arrowMarker = defs.append("marker")
                          .attr("id", "arrow")
                          .attr("markerUnits", "strokeWidth")
                          .attr("markerWidth", "12")
                          .attr("markerHeight", "12")
                          .attr("viewBox", "0 0 12 12")
                          .attr("refX", "6")
                          .attr("refY", "6")
                          .attr("orient", "auto");

       var lineX = svg3.append("line")
                    .attr("x1", 200)
                    .attr("x2", 400)
                    .attr("y1", 300)
                    .attr("y2", 300)
                    .attr("stroke-width", 2)
                    .attr("marker-end", "url(#arrow)");

       var lineZ = svg3.append("line")
                     .attr("x1", 200)
                     .attr("x2", 200)
                     .attr("y1", 300)
                     .attr("y2", 20)
                     .attr("stroke-width", 2)
                     .attr("marker-end", "url(#arrow)");

       var lineY = svg3.append("line")
                     .attr("x1", 200)
                     .attr("x2", 59)
                     .attr("y1", 300)
                     .attr("y2", 441)
                     .attr("stroke-width", 2)
                     .attr("marker-end", "url(#arrow)");



       var arrowPath = "M2,2 L10,6 L2,10 L6,6 L2,2";
       arrowMarker.append("path")
                  .attr("d", arrowPath)
                  .attr("fill", "#000");
    }



/*****************    View4 Part ***************************************/
  function drawView4(strIP) {

    var tt = 0;
    var kk = 0;
    srcIP = [];
    nodes = [];
    edges = [];
    //console.log("csvdata="+csvdata);
      d3.csv("datatry4.csv", function(error, cdata){
         if(error){
          console.log(error);
         }
         console.log("hahha");
          var pos1;//代表月份开头的位置
          var pos2;//代表日期开头的位置
          var postime1;//代表分钟开头的位置
          var postime2;//代表秒开头的位置
          var si = 1;
          var sl = 1;
         for(var q=0;q<cdata.length;q++){
 
          for(var tmp9=0;tmp9<10;tmp9++){
          if(cdata[q].date.substring(tmp9, tmp9+1) == "/" && si == 1){
               pos1 = tmp9+1;
               si = 0;
             
          }else{
          if(cdata[q].date.substring(tmp9, tmp9+1) == "/" && si == 0){
               pos2 = tmp9+1;
             

            }
           }
          if(cdata[q].time.substring(tmp9, tmp9+1) == ":" && sl == 1){
            postime1 = tmp9+1;
            sl = 0;
          }else{
            if(cdata[q].time.substring(tmp9, tmp9+1) == ":" && sl == 0){
              postime2 = tmp9+1;
            }
          }
          }



          if(parseInt(cdata[q].date.substring(pos2, cdata[q].date.length)) >= day1 && parseInt(cdata[q].date.substring(pos2, cdata[q].date.length)) <= day2){
            //console.log("lalala1");
            if(parseInt(cdata[q].time.substring(0, 2)) >= hour1 && parseInt(cdata[q].time.substring(0, 2)) <= hour2){
              //console.log("lalala2");
              if(parseInt(cdata[q].time.substring(3, 5)) >= minute1 && parseInt(cdata[q].time.substring(3, 5)) <= minute2){
                //console.log("lalala3");
                if(parseInt(cdata[q].time.substring(6, 8)) >= second1 && parseInt(cdata[q].time.substring(6, 8)) <= second2){
                 // console.log("lalala"+(cdata[q].time.substring(3, 5)));

                  if(cdata[q].destIP == strIP){
                    for(kk=0;kk<srcIP.length;kk++){
                       if(srcIP[kk].src == cdata[q].srcIP && srcIP[kk].dst == strIP){
                            //同一个源ip
                             srcIP[kk].times++;
                             break;
                           }
                      }
                      if(kk == srcIP.length){
                        //没找到重复的
                        srcIP.push({
                           src: cdata[q].srcIP,
                           dst: strIP,
                           times: 1
                         });
                      }
                  }

                }

              }

            }

          }
        }  
       //console.log(srcIP);
       var tmp10 = 0;

       for(var ii=0;ii<srcIP.length;ii++){
        if(ii == 0){
          //第一次进
          nodes.push({
            name: "src"+srcIP[ii].src,
            no: tmp10
          });

          nodes.push({
            name: "dst"+srcIP[ii].dst,
            no: tmp10+1
          });

          edges.push({
            source: tmp10,
            target: tmp10+1,
            times: srcIP[ii].times
          });
          tmp10 = tmp10+2;
        }else{
          
          if(srcIP[ii].src != srcIP[ii-1].src){
            //src创立一个新的点,由于src按倒序排序了
             console.log("hahahahahaha223");

            nodes.push({
              name: "src"+srcIP[ii].src,
              no: tmp10
            });

            for(var nn=tmp10-1;nn>=0;nn--){
              //往回找，看看dst的点是否已存在
              if(nodes[nn].name == "dst"+srcIP[ii].dst){
                //找到了一个重复的点,src点不重复添加
                edges.push({
                   source: tmp10,
                   target: nodes[nn].no,
                   times: srcIP[ii].times
                });

                break;
                
              }

            }
            tmp10++;

            if(nn<0){
              //往回木有找到
              nodes.push({
                name: "dst"+srcIP[ii].dst,
                no: tmp10
              });
              edges.push({
                source: tmp10-1,
                target: tmp10,
                times: srcIP[ii].times
              });
              tmp10++;
            }
          }else{
            //src的点重复了，所以不用再添加那个点
            var tmp15;
            //找到那个src重复的点
            console.log("tmp10="+tmp10);
           
            for(var aa=tmp10-1;aa>=0;aa--){
              
              if(nodes[aa].name == "src"+srcIP[ii].src){
                tmp15 = aa;
                //console.log(tmp15);
                break;
                
              }
            }

            console.log("tmp15="+tmp15);
            for(var nn=tmp10-1;nn>=0;nn--){
              //往回找，看看dst的点是否已存在
              //console.log("hahahahahaha223");
              if(nodes[nn].name == "dst"+srcIP[ii].dst){
                //找到了一个dst重复的点,src点不重复添加

                edges.push({
                   source: tmp15,
                   target: nodes[nn].no,
                   times: srcIP[ii].times
                });

                break;
                
              }

            }
            
            if(nn<0){
              //往回木有找到
              nodes.push({
                name: "dst"+srcIP[ii].dst,
                no: tmp10
              });
              edges.push({
                source: tmp15,
                target: tmp10,
                times: srcIP[ii].times
              });
              tmp10++;
            }
          }

        }

       }

       console.log(nodes);
       console.log(edges);

       startForce();


      });
        
  }
   function startForce(){
     d3.selectAll(".lineF").remove();
     d3.selectAll(".circleF").remove();
     var iii = 0;
      var force = d3.layout.force()
                .nodes(nodes)
                .links(edges)
                .size([300, 200])
                .linkDistance(function(){
                  
                  return edges[iii++].times+50*0.667;//因为次数多位1，2等，所以加100为了效果好

                })
                .charge(-20);

      force.start();

      var svg_edges = svg1.selectAll("lineF")
                      .data(edges)
                      .enter()
                      .append("line")
                      //.append("text")
                      .attr("class", "lineF")
                      .style("stroke", "#bebebe")
                      .style("stroke-width", 1)
                      .on("mouseover", function(d, j){
                        var ccc = d3.mouse(this);
                          var cxx = ccc[0];
                          var cyy = ccc[1];

                          var tips = svg1.append("g").attr("class", ".tips2");
                          tips.append("rect")
                              .attr("class", "tips-border2")
                              .attr("width", 150)
                              .attr("height",50)
                              .attr("x", function(){

                                 if(cxx > 150) cxx -= 150;
                                 return cxx;
                              })
                              .attr("y", function(){
                                if(cyy > 150) cyy -= 50;
                                return cyy;
                              })
                              .attr("rx", 10*0.667)
                              .attr("ry", 10*0.667);

                          var word1 = tips
                              .append("text")
                              .attr("class", "tips-text2")
                              .attr("x", cxx+5)
                              .attr("y", cyy+20)
                              .text(function(){
                                 //console.log(nodes[j].name);
                                 return "attackTimes:"+edges[j].times;
                              });

                       
                      })
                     .on("mouseout", function(d, j){
                       svg1.selectAll(".tips-border2").remove();
                         svg1.selectAll(".tips-text2").remove();
                     });

    var color = d3.scale.category20();

    var svg_nodes = svg1.selectAll("circleF")
                       .data(nodes)
                       .enter()
                       .append("circle")
                       .attr("class", "circleF")
                       .attr("r", 5)
                       .style("fill", function(d, i){
                         if(nodes[i].name.substring(0, 3) == "src"){
                           return "red";
                         }else{
                          return "green";
                         }

                       })
                       .on("mouseover", function(d, j){

                          var ccc = d3.mouse(this);
                          var cxx = ccc[0];
                          var cyy = ccc[1];

                          var tips = svg1.append("g").attr("class", ".tips2");
                          tips.append("rect")
                              .attr("class", "tips-border2")
                              .attr("width", 150)
                              .attr("height",50)
                              .attr("x", function(){

                                 if(cxx > 150) cxx -= 150;
                                 return cxx;
                              })
                              .attr("y", function(){
                                if(cyy > 150) cyy -= 50;
                                return cyy;
                              })
                              .attr("rx", 10*0.667)
                              .attr("ry", 10*0.667);

                          var word1 = tips
                              .append("text")
                              .attr("class", "tips-text2")
                              .attr("x", cxx+5)
                              .attr("y", cyy+20)
                              .text(function(){
                                 //console.log(nodes[j].name);
                                 return nodes[j].name;
                              });

                          var word2 = tips.append("text")
                              .attr("class", "tips-text2")
                              .attr("x", cxx+5)
                              .attr("y", cyy+40)
                              .text(function(){
                                 return "no."+nodes[j].no;
                              });

                       })
                       .on("mouseout", function(){
                        svg1.selectAll(".tips-border2").remove();
                         svg1.selectAll(".tips-text2").remove();
                        svg1.selectAll(".tips2")
                          .style("display", "none");
                       })
                       .call(force.drag);


    force.on("tick", function(){
      svg_edges.attr("x1", function(d){return d.source.x; })
               .attr("y1", function(d){return d.source.y; })
               .attr("x2", function(d){return d.target.x; })
               .attr("y2", function(d){return d.target.y; });

      svg_nodes.attr("cx", function(d){ return d.x; })
               .attr("cy", function(d){ return d.y; });
      
      /*
      svg_texts.attr("x", function(d){ return d.x; })
               .attr("y", function(d){ return d.y; });*/
    });
   }

/********************   View 3 Graph ********************************/
  //要保证其最后
   function drawGraph() {
       var nodesDst = new Array();
       var nodesSrc = new Array();
       edgesG = [];
       var hh = 1;
       var ss = 1;
       d3.csv("datatry3.csv", function(error, idata){
          if(error){
            console.log(error);
          }

          for(var uu=0;uu<idata.length;uu++){
            if(uu == 0){
               nodesDst.push({
                 ip: idata[uu].destIP,
                 no: 0,
                 times: 1
                 
               });
               nodesSrc.push({
                 ip: idata[uu].srcIP,
                 no: 0,
                 times: 1

               });
               edgesG.push({
                 source: idata[uu].srcIP,
                 target: idata[uu].destIP,
                 no1: 0,
                 no2: 0
               });

            }else{
               if(idata[uu].srcIP != idata[uu-1].srcIP){
                //因为倒序排的所以可以这么写
                //srcIP没有重复
                 nodesSrc.push({
                   ip: idata[uu].srcIP,
                   no: ss,
                   times: 1
                 });

                 for(var z=0;z<hh;z++){
                   if(nodesDst[z].ip == idata[uu].destIP){
                    //dstip有重复:nodeDst不加，edgesg加，dstnodes次数加
                    edgesG.push({
                      source: idata[uu].srcIP,
                      target: idata[uu].destIP,
                      no1: ss,
                      no2: nodesDst[z].no

                    });
                    ss++;
                    nodesDst[z].times++;
                    break;
                   }
                 }
                 if(z == hh){
                  //dstip没有重复，三个都加
                   nodesDst.push({
                     ip: idata[uu].destIP,
                     no: hh,
                     times: 1
                   });
                   edgesG.push({
                     source: idata[uu].srcIP,
                     target: idata[uu].destIP,
                     no1: ss,
                     no2: hh
                   });
                   ss++;
                   hh++;
                 }

               }else{
                //srcip有重复
                 for(var z=0;z<hh;z++){
                  if(nodesDst[z].ip == idata[uu].destIP){
                    //dstip也有重复，都不加，只加times
                    nodesDst[z].times++;
                    nodesSrc[ss-1].times++;
                    break;

                  }
                 }
                 if(z == hh){
                  //dstip没重复，加入新dstnodes,加老srcnodes的times，加edges
                   nodesDst.push({
                     ip: idata[uu].destIP,
                     no: hh,
                     times: 1
                   });
                   nodesSrc[ss-1].times++;
                   edgesG.push({
                    source: idata[uu].srcIP,
                    target: idata[uu].destIP,
                    no1: ss-1,
                    no2: hh
                   });
                   hh++;
                 }

               }
            }
          }
          
          console.log(nodesDst);
          console.log(nodesSrc);
          console.log(edgesG);

          var sheight = 0;
          var dheight = 0;
          
          var circleGS = svg5.selectAll(".circleGS")
                            .data(nodesSrc)
                            .enter()
                            .append("g")
                            .append("circle")
                            .attr("class", "circleGS")
                            .attr("id", function(d, i){
                                return 10*i;
                            })
                            .attr("stroke", "black")
                            .style("fill", "black")
                            .attr("r", function(d, i){
                              //console.log(nodesSrc[i].times/4);
                              if(nodesSrc[i].times/2>20){
                                return 20;
                              }else
                              return nodesSrc[i].times/2;
                            })
                            .attr("cx", 40)
                            .attr("cy", function(d, i){
                              if(i == 0){
                                if(nodesSrc[0].times/2>20){
                                  sheight += 20;

                                }else{
                                sheight += nodesSrc[0].times/2;}
                                return sheight;
                              }else{
                                if(nodesSrc[i].times/2>20 && nodesSrc[i-1].times/2>20){
                                  sheight += 40;
                                }else if(nodesSrc[i].times/2>20 || nodesSrc[i-1].times/2>20){
                                  sheight += 20;
                                  if(nodesSrc[i].times/2>20){
                                    sheight += nodesSrc[i-1].times/2;
                                  }else{
                                    sheight += nodesSrc[i].times/2;
                                  }
                                }else{
                                    sheight = sheight+nodesSrc[i-1].times/2+nodesSrc[i].times/2;}
                                return sheight;
                              }
                            })
                            .on("mouseover", function(){
                               d3.select(this).attr("stroke", "red");
                            })
                            .on("mouseout", function(){
                              d3.select(this).attr("stroke", "black");
                            });

          var circleGD = svg5.selectAll(".circleGD")
                            .data(nodesDst)
                            .enter()
                            .append("g")
                            .append("circle")
                            .attr("class", "circleGD")
                            .attr("id", function(d, i){
                                return i;
                            })
                            .attr("stroke", "black")
                            .style("fill", "black")
                            .attr("r", function(d, i){
                              if(nodesDst[i].times/2>20){
                                return 20;
                              }else
                              return nodesDst[i].times/2;
                            })
                            .attr("cx", 365)
                            .attr("cy", function(d, i){
                              //console.log(dheight);
                              //console.log(nodesDst[i].times);

                             
                              if(i == 0){
                                if(nodesDst[0].times/2 > 20){
                                  dheight += 20;

                                }else{
                                dheight += nodesDst[0].times/2;}
                                return dheight;
                              }else{
                                if(i>8 && i<20){
                                  console.log(dheight);
                                  console.log(nodesDst[i].ip);
                                console.log(nodesDst[i].times);
                                console.log(nodesDst[i-1].times);}
                                if(nodesDst[i].times/2>20 && nodesDst[i-1].times/2>20){
                                  dheight += 40;
                                }else {
                                  if(nodesDst[i].times/2>20){
                                    dheight = dheight+20+nodesDst[i-1].times/2;
                                  }else if(nodesDst[i-1].times/2>20){
                                    dheight = dheight+20+nodesDst[i].times/2;
                                      }
                                     else{
                                    dheight = dheight+nodesDst[i-1].times/2+nodesDst[i].times/2;
                                      }
                                  }
                                return dheight;
                              }
                            })
                            .on("mouseover", function(){
                              d3.select(this).attr("stroke", "red");
                            })
                            .on("mouseout", function(){
                              d3.select(this).attr("stroke", "black");
                            });

          var tmp17 = 0;
          var tmp18 = 0;
          var lineG = svg5.selectAll(".lineG")
                         .data(edgesG)
                         .enter()
                         .append("g")
                         .append("line")
                         .attr("class", "lineG")
                         .attr("id", function(d, i){
                          return edgesG[i].target+"-"+(edgesG[i].no2+"");
                         })
                         .attr("stroke", "black")
                         .attr("stroke-width", 0.2)
                         .style("fill", "none")
                         .attr("x1", 40)
                         .attr("x2", 365)
                         .attr("y1", function(d, i){
                           tmp17 = 0;
                          for(var ll=edgesG[i].no1-1;ll>=0;ll--){
                            if(nodesSrc[ll].times/2>20){
                              tmp17 += 40;
                            }else{
                            tmp17 += 2*nodesSrc[ll].times/2;
                            }
                          }
                          if(nodesSrc[edgesG[i].no1].times/2 > 20){
                            tmp17 += 20;
                          }else{
                            tmp17 += nodesSrc[edgesG[i].no1].times/2;
                          }
                          return tmp17;
                         })
                         .attr("y2", function(d, i){
                            tmp18 = 0;
                          for(var lll=edgesG[i].no2-1;lll>=0;lll--){
                            if(nodesDst[lll].times/2 > 20){
                              tmp18 += 40;
                            }else{
                            tmp18 += 2*nodesDst[lll].times/2;
                            }
                           
                          }
                          if(nodesDst[edgesG[i].no2].times/2 > 20){
                            tmp18 += 20;
                          }else{
                            tmp18 += nodesDst[edgesG[i].no2].times/2;
                          }
                          return tmp18;
                         })
                         .on("mouseover", function(){
                           d3.select(this).attr("stroke", "red")
                           .attr("stroke-width", 1);
                         })
                         .on("mouseout", function(){
                          d3.select(this).attr("stroke", "black")
                          .attr("stroke-width", 0.2)
                         });

       });
   }

    





/*******************        div part             **********************/
    //有关div的函数，点击第一个时间间隔后选择是否显示第二个
    function interval(Interval){
      if(Interval.value == '0'){
        document.getElementById('day').style.display = 'block';
        document.getElementById('hour').style.display = 'none';
        document.getElementById('minute').style.display = 'none';
        
      }
      else if(Interval.value == '1'){
        document.getElementById('hour').style.display = 'block';
        document.getElementById('day').style.display = 'none';
        document.getElementById('minute').style.display = 'none';
       
      }
      else if(Interval.value == '2'){
        document.getElementById('minute').style.display = 'block';
        document.getElementById('day').style.display = 'none';
        document.getElementById('hour').style.display = 'none';
        
      }
     
      
    }

   //
    function changeTimes(){
        currentTimes = document.getElementById("timesBar").value;
        console.log("currentTimes="+currentTimes);

        document.getElementById("times").value = currentTimes;
        d3.selectAll("svg").remove();

       search();

    }

    function timeaxis() {
        ipa = document.getElementById("timeaxis1").value;
        console.log("ipa="+ipa);

        ipb = document.getElementById("timeaxis2").value;
        console.log("ipb="+ipb);

        document.getElementById("time1").value = ipa;
        document.getElementById("time2").value = ipb;

        search();
    }

    function SwitchData(){
      ipa = document.getElementById("time1").value; //本代码中的ip-a
      ipb = document.getElementById("time2").value; //本代码中的ip-b

      search();
      
    }

   //检测timeline模块变化用
    function timeChange() {
       var tmp11;
       var tmp12;
       var tmp13;
       var tmp14;
       var tmp5;
       var tmp6;
       var tmp7;
       var tmp8;

       tmp11 = $(".range").val();
       tmp12 = $(".range2").val();
       tmp13 = $(".range3").val();
       tmp14 = $(".range4").val();

       for(var tt=0;tt<10;tt++){
        if(tmp11[tt] == ',') tmp5 = tt;
        if(tmp12[tt] == ',') tmp6 = tt;
        if(tmp13[tt] == ',') tmp7 = tt;
        if(tmp14[tt] == ',') tmp8 = tt;
       }

       day1 = parseInt(tmp11.substring(0, tmp5));
       day2 = parseInt(tmp11.substring(tmp5+1, tmp11.length));
       
       hour1 = parseInt(tmp12.substring(0, tmp6));
       hour2 = parseInt(tmp12.substring(tmp6+1, tmp12.length));

       minute1 = parseInt(tmp13.substring(0, tmp7));
       minute2 = parseInt(tmp13.substring(tmp7+1, tmp13.length));

       second1 = parseInt(tmp14.substring(0, tmp8));
       second2 = parseInt(tmp14.substring(tmp8+1, tmp14.length));
      
       search();


        
    }

    function brush(){
       svg5.selectAll(".lineG")
           .style("fill", "none")
           .attr("stroke", "black")
           .attr("stroke-width", 0.2);
    }


    
 </script>

</body>
</html>